<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Happy Birthday ‚Äî Maneesha üéâ</title>
<style>
  :root{
    --bg1:#E8FFFB; --bg2:#D7FFF2; --accent:#2FBF91; --text:#21312B; --card:#ffffffdd;
  }
  html,body{height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  body{display:flex; align-items:center; justify-content:center; background:linear-gradient(160deg,var(--bg1),var(--bg2)); padding:24px; color:var(--text);}
  .stage{width:min(980px,96vw); background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9)); border-radius:18px; box-shadow:0 18px 40px rgba(10,40,30,0.06); padding:20px; display:grid; grid-template-columns:1fr 380px; gap:16px; position:relative;}
  @media(max-width:840px){ .stage{grid-template-columns:1fr} .side{order:-1} }

  .left{padding:6px}
  h1{margin:6px 0 8px; font-size:clamp(20px,3.6vw,32px)}
  .sub{color:#3b5b50; margin-bottom:10px}
  .card-text{background:var(--card); padding:12px; border-radius:12px; border:1px solid rgba(0,0,0,0.04)}
  .controls{margin-top:12px; display:flex; gap:10px; flex-wrap:wrap}
  button{appearance:none;border:0;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600;background:transparent;border:1px solid rgba(0,0,0,0.06)}
  .note{font-size:13px;color:#516c61;margin-top:10px}

  .side{display:flex;align-items:center;justify-content:center}
  .portrait{width:320px;height:320px;border-radius:16px;overflow:hidden;background:linear-gradient(180deg,#fff,#f6fff9);position:relative;box-shadow:0 8px 24px rgba(18,36,28,0.06);border:1px solid rgba(255,255,255,0.6)}
  .portrait img{width:100%;height:100%;object-fit:cover;display:block}
  .portrait .placeholder{display:flex;align-items:center;justify-content:center;height:100%;color:#617f73;font-weight:700;font-size:20px}

  /* cake */
  .cake-wrap{position:absolute; right:18px; bottom:18px; width:150px; height:150px; display:flex;align-items:center;justify-content:center;pointer-events:none}
  .cake-card{width:150px;height:150px;border-radius:14px;background:linear-gradient(180deg,#fff,#f9fffa);box-shadow:0 10px 30px rgba(12,30,20,0.05);pointer-events:auto;display:flex;align-items:center;justify-content:center;position:relative;border:1px solid rgba(0,0,0,0.03)}
  .prompt{position:absolute; bottom:-36px; left:50%; transform:translateX(-50%); background:white;padding:8px 10px;border-radius:999px; box-shadow:0 8px 18px rgba(0,0,0,0.06); font-weight:600; font-size:13px}
  /* make an invisible larger hit area for mobile */
  .flame-hit{position:absolute; width:64px; height:64px; left:50%; top:18%; transform:translateX(-50%); border-radius:50%; background:transparent; cursor:pointer; pointer-events:auto;}

  .flame{transform-origin:center bottom; animation:flame-flicker 900ms infinite}
  @keyframes flame-flicker{0%{transform:scaleY(1)}50%{transform:scaleY(.92)}100%{transform:scaleY(1)}}
  .extinguished{animation:none; transform:scaleY(0.02) translateY(8px); opacity:0; transition:transform .48s ease, opacity .42s ease}

  /* smoke */
  .smoke{position:fixed; border-radius:50%; pointer-events:none; mix-blend-mode:screen}

  canvas.confetti{position:fixed; left:0; top:0; width:100vw; height:100vh; pointer-events:none; z-index:9999}
</style>
</head>
<body>
  <canvas id="confettiCanvas" class="confetti" aria-hidden="true"></canvas>

  <main class="stage" role="main" aria-labelledby="pageTitle">
    <section class="left">
      <h1 id="pageTitle">Happy Birthday, <span id="namePlace">Maneesha</span> üéâ</h1>
      <div class="sub">A little surprise from your best friend ‚Äî blow the candle and make a wish!</div>

      <div class="card-text" id="shortCard">Wishing you a day of laughter, tiny adventures, and warm tea on cozy afternoons.</div>

      <div class="controls">
        <button id="playBtn">‚ñ∂Ô∏è Play/Stop Music</button>
        <button id="downloadBtn">üì∑ Save Portrait</button>
      </div>

      <div class="note">Tip: press <strong>B</strong> to blow the candle. Page refresh allows one more blow.</div>
    </section>

    <aside class="side">
      <figure class="portrait" role="img" aria-label="Photo of Maneesha">
        <img id="portraitImg" alt="Maneesha portrait" crossorigin="anonymous" />
        <div class="placeholder" id="portraitPlaceholder" style="display:none">Maneesha</div>

        <div class="cake-wrap" id="cakeWrap">
          <div class="cake-card" id="cakeCard" role="button" aria-pressed="false" aria-label="Cake with candle. Click to blow.">
            <!-- cake SVG -->
            <svg class="cake-svg" viewBox="0 0 64 64" width="120" height="120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <rect x="8" y="28" width="48" height="18" rx="3" fill="#FFF9EE" stroke="#F3E7D6"/>
              <path d="M8 28c6-6 18-6 26-1 8-5 20-5 26 1" fill="#FFEEE9"/>
              <rect x="26" y="20" width="4" height="10" rx="0.6" fill="#FFFFFF" stroke="#FFEFCB"/>
              <g id="flameGroup" transform="translate(0,0)">
                <path id="flame" class="flame" d="M32 16c0 2.6-2 3.8-2 3.8s0-2 0-3.8 1-2.4 2-2.4 1 0.6 1 2.4z" fill="#FFD66B"/>
                <path id="flameInner" class="flame" d="M32 17c0 1.6-1 2.2-1 2.2s0-1 0-2.2 0.6-1.2 1-1.2 1 0.2 1 1.2z" fill="#FFB86B" opacity="0.95"/>
              </g>
            </svg>

            <!-- large invisible hit area (better for mobile) -->
            <button class="flame-hit" id="flameHit" aria-label="Blow the candle" title="Click to blow the candle"></button>
          </div>
          <div class="prompt" id="cakePrompt">Click the candle to blow it üí®</div>
        </div>
      </figure>
    </aside>
  </main>

<script>
/* ---------------- Configuration ---------------- */
const recipientName = 'Maneesha';
document.getElementById('namePlace').textContent = recipientName;

/*
 portraitDataURI: if you want single-file, paste your full base64 data URI here (VERY LONG).
 Example:
   const portraitDataURI = "data:image/jpeg;base64,/9j/4AAQSkZJRgA...";
 If you leave it blank the script will fallback to ./image.jpg (repo root).
*/
const portraitDataURI = ""; // <-- leave empty (we use ./image.jpg) or paste full data URI string

// fallback path (repo root ‚Äî same folder as index.html)
const portraitLocalPath = "./image.jpg";

/* ---------------- DOM refs ---------------- */
const portraitImg = document.getElementById('portraitImg');
const portraitPlaceholder = document.getElementById('portraitPlaceholder');
const flame = document.getElementById('flame');
const flameInner = document.getElementById('flameInner');
const flameHit = document.getElementById('flameHit');
const cakeCard = document.getElementById('cakeCard');
const cakePrompt = document.getElementById('cakePrompt');
const playBtn = document.getElementById('playBtn');
const downloadBtn = document.getElementById('downloadBtn');
const confCanvas = document.getElementById('confettiCanvas');

let hasBlown = false;
let audioCtx = null;
let playLooping = false;

/* ---------------- Portrait loading with fallback ---------------- */
function setPortrait(src){
  portraitPlaceholder.style.display = 'none';
  portraitImg.style.display = 'block';
  portraitImg.src = src;
  portraitImg.onerror = () => {
    console.warn("Portrait failed to load:", src);
    portraitImg.style.display = 'none';
    portraitPlaceholder.style.display = 'flex';
  };
}

if(portraitDataURI && portraitDataURI.startsWith('data:')){
  setPortrait(portraitDataURI);
} else {
  setPortrait(portraitLocalPath);
}

/* ---------------- Confetti (lightweight) ---------------- */
let dpr = window.devicePixelRatio || 1;
function resizeCanvas(){
  dpr = window.devicePixelRatio || 1;
  confCanvas.width = innerWidth * dpr;
  confCanvas.height = innerHeight * dpr;
  confCanvas.style.width = innerWidth + 'px';
  confCanvas.style.height = innerHeight + 'px';
  const ctx = confCanvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

const ctx = confCanvas.getContext('2d');
let confetti = [];
function spawnConfetti(n=100){
  for(let i=0;i<n;i++){
    confetti.push({
      x: Math.random()*innerWidth,
      y: -Math.random()*200,
      w: 6 + Math.random()*12,
      h: 4 + Math.random()*6,
      vx: -1 + Math.random()*2,
      vy: 2 + Math.random()*6,
      ang: Math.random()*Math.PI*2,
      vr: (-0.05 + Math.random()*0.1),
      color: ['#2FBF91','#FFD66B','#FFB86B','#72E0FF','#C2F7FF'][Math.floor(Math.random()*5)]
    });
  }
}
let confRunning = false;
function updateDrawConfetti(){
  ctx.clearRect(0,0,confCanvas.width,confCanvas.height);
  for(let p of confetti){
    p.x += p.vx; p.y += p.vy; p.ang += p.vr;
    ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.ang);
    ctx.fillStyle = p.color;
    ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
    ctx.restore();
  }
  confetti = confetti.filter(p => p.y < innerHeight + 100);
}
function confettiLoop(){
  if(!confRunning) return;
  updateDrawConfetti();
  requestAnimationFrame(confettiLoop);
}
function startConfetti(){
  if(confRunning) return;
  confRunning = true; spawnConfetti(140); confettiLoop();
  setTimeout(()=>{ confRunning=false; confetti=[]; ctx.clearRect(0,0,confCanvas.width,confCanvas.height); }, 7000);
}

/* ---------------- Smoke effect ---------------- */
function makeSmokeBurst(count=6){
  for(let i=0;i<count;i++){
    setTimeout(()=>{
      const s = document.createElement('div');
      s.className = 'smoke';
      const size = 12 + Math.random()*36;
      s.style.width = s.style.height = size + 'px';
      const rect = cakeCard.getBoundingClientRect();
      const left = rect.left + rect.width/2 + (Math.random()*60-30) - size/2;
      const top = rect.top + rect.height*0.15 - size/2;
      s.style.left = left + 'px'; s.style.top = top + 'px';
      s.style.opacity = 0.95;
      s.style.background = 'radial-gradient(circle, rgba(200,200,200,0.95), rgba(180,180,180,0.25))';
      document.body.appendChild(s);
      const driftX = (-40 + Math.random()*80);
      const rise = -110 - Math.random()*80;
      s.animate([
        { transform:'translate(0,0) scale(0.6)', opacity:0.95 },
        { transform:`translate(${driftX}px, ${rise/2}px) scale(1.05)`, opacity:0.6 },
        { transform:`translate(${driftX*1.2}px, ${rise}px) scale(1.4)`, opacity:0.08 }
      ], { duration:900 + Math.random()*600, easing:'ease-out' }).onfinish = ()=> s.remove();
    }, i*80);
  }
}

/* ---------------- Audio (birdsy jingle) ---------------- */
function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}
function playBirdsyJingleOnce(){
  ensureAudio();
  const now = audioCtx.currentTime;
  const notes = [880, 1320, 990, 1320, 1760];
  const durations = [0.12,0.12,0.14,0.16,0.28];

  // pad
  const pad = audioCtx.createOscillator();
  const padGain = audioCtx.createGain();
  pad.type='sine'; pad.frequency.value=220; padGain.gain.value=0.0008;
  pad.connect(padGain); padGain.connect(audioCtx.destination);
  pad.start(now); pad.stop(now + 5.5);

  // chirps
  let t = now + 0.02;
  for(let i=0;i<notes.length;i++){
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type='triangle'; o.frequency.value = notes[i];
    g.gain.setValueAtTime(0.00001, t);
    g.gain.exponentialRampToValueAtTime(0.0025, t+0.02);
    g.gain.exponentialRampToValueAtTime(0.00001, t+durations[i]);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(t); o.stop(t + durations[i] + 0.06);
    t += durations[i] + 0.06;
  }
}

/* ---------------- Blow sequence (one-time) ---------------- */
let blowing = false;
async function blowSequence(){
  if(hasBlown || blowing) return;
  blowing = true;
  cakeCard.setAttribute('aria-pressed','true');
  cakePrompt.textContent = 'Blowing... Make a wish!';
  try{
    ensureAudio();
    // little puff sound
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type='triangle'; o.frequency.value=1500; g.gain.value=0.0006;
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); g.gain.exponentialRampToValueAtTime(0.02, audioCtx.currentTime + 0.02);
    g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.22);
    o.frequency.exponentialRampToValueAtTime(700, audioCtx.currentTime + 0.22);
    o.stop(audioCtx.currentTime + 0.26);
  }catch(e){ console.warn("Audio not available yet:", e); }

  // extinguish flame (toggle class)
  if(flame) flame.classList.add('extinguished');
  if(flameInner) flameInner.classList.add('extinguished');

  // jiggle effect (apply quick transform)
  cakeCard.animate([{ transform:'translateY(0)' }, { transform:'translateY(-8px) rotate(-3deg)' }, { transform:'translateY(0) rotate(2deg)' }], { duration:420, iterations:3, easing:'ease-in-out' });

  // smoke
  makeSmokeBurst(7);

  // after dramatic delay reveal confetti + jingle + mark as blown
  setTimeout(()=>{
    startConfetti();
    playBirdsyJingleOnce();
    cakePrompt.textContent = 'Wish made! ‚ú® (Refresh to replay once)';
    hasBlown = true;
    blowing = false;
  }, 1700);
}

/* ---------------- Event wiring ---------------- */
// make flame hit area clickable
flameHit.addEventListener('click', (e)=>{ e.stopPropagation(); blowSequence(); });
cakeCard.addEventListener('click', ()=> blowSequence());
// keyboard B
window.addEventListener('keydown', (e)=> { if(e.key && e.key.toLowerCase()==='b') blowSequence(); });

/* Play/Stop music - loops short jingle (works after a user gesture) */
playBtn.addEventListener('click', ()=>{
  ensureAudio();
  if(!playLooping){
    playLooping = true; playBtn.textContent = '‚è∏ Stop Music';
    (function loopOnce(){
      if(!playLooping) return;
      playBirdsyJingleOnce();
      setTimeout(()=>{ if(playLooping) loopOnce(); }, 1200);
    })();
  } else {
    playLooping = false; playBtn.textContent = '‚ñ∂Ô∏è Play/Stop Music';
  }
});

/* Download portrait */
downloadBtn.addEventListener('click', async ()=>{
  try{
    const src = portraitImg.src;
    const resp = await fetch(src, {mode:'cors'});
    const blob = await resp.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${recipientName||'portrait'}.jpg`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(a.href);
  }catch(err){
    console.warn("Download failed:", err);
    alert("Couldn't auto-download. If you embedded a data URI, right-click the image and choose Save image (or upload the image to ./image.jpg and try again).");
  }
});

/* Helpful console log */
console.log("Birthday page loaded. portraitDataURI length:", portraitDataURI.length, "Using local path:", portraitLocalPath);
</script>
</body>
</html>
