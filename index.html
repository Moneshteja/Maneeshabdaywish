<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Happy Birthday ‚Äî Maneesha üéâ</title>
<style>
  :root{
    --bg1:#E8FFFB; --bg2:#D7FFF2; --accent:#2FBF91; --text:#21312B; --card:#ffffffee;
  }
  html,body{height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  body{display:flex; align-items:center; justify-content:center; background:linear-gradient(160deg,var(--bg1),var(--bg2)); padding:24px; color:var(--text);}
  .stage{width:min(980px,96vw); background:linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.92)); border-radius:18px; box-shadow:0 18px 40px rgba(10,40,30,0.06); padding:20px; display:grid; grid-template-columns:1fr 380px; gap:16px; position:relative;}
  @media(max-width:840px){ .stage{grid-template-columns:1fr} .side{order:-1} }

  .left{padding:6px}
  h1{margin:6px 0 8px; font-size:clamp(20px,3.6vw,32px)}
  .sub{color:#3b5b50; margin-bottom:10px}
  .card-text{background:var(--card); padding:12px; border-radius:12px; border:1px solid rgba(0,0,0,0.04)}
  .controls{margin-top:12px; display:flex; gap:10px; flex-wrap:wrap}
  button{appearance:none;border:0;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700;background:transparent;border:1px solid rgba(0,0,0,0.06)}
  .note{font-size:13px;color:#516c61;margin-top:10px}

  .side{display:flex;align-items:center;justify-content:center}
  .portrait{width:320px;height:320px;border-radius:16px;overflow:hidden;background:linear-gradient(180deg,#fff,#f6fff9);position:relative;box-shadow:0 8px 24px rgba(18,36,28,0.06);border:1px solid rgba(255,255,255,0.6)}
  .portrait img{width:100%;height:100%;object-fit:cover;display:block}
  .portrait .placeholder{display:flex;align-items:center;justify-content:center;height:100%;color:#617f73;font-weight:700;font-size:20px}

  /* cake */
  .cake-wrap{position:absolute; right:18px; bottom:18px; width:150px; height:150px; display:flex;align-items:center;justify-content:center;pointer-events:none}
  .cake-card{width:150px;height:150px;border-radius:14px;background:linear-gradient(180deg,#fff,#f9fffa);box-shadow:0 10px 30px rgba(12,30,20,0.05);pointer-events:auto;display:flex;align-items:center;justify-content:center;position:relative;border:1px solid rgba(0,0,0,0.03)}
  .prompt{position:absolute; bottom:-44px; left:50%; transform:translateX(-50%); background:white;padding:8px 12px;border-radius:999px; box-shadow:0 8px 18px rgba(0,0,0,0.06); font-weight:700; font-size:13px}
  .flame-hit{position:absolute; width:86px; height:86px; left:50%; top:18%; transform:translateX(-50%); border-radius:50%; background:transparent; cursor:pointer; pointer-events:auto; outline:none; border:0; }

  .flame{transform-origin:center bottom; animation:flame-flicker 900ms infinite}
  @keyframes flame-flicker{0%{transform:scaleY(1)}50%{transform:scaleY(.92)}100%{transform:scaleY(1)}}
  .extinguished{animation:none; transform:scaleY(0.02) translateY(8px); opacity:0; transition:transform .48s ease, opacity .42s ease}

  /* wish reveal */
  #surpriseArea{position:relative; margin-top:18px; display:none; opacity:0; transform:translateY(18px); transition:all .7s cubic-bezier(.2,.9,.3,1); background:linear-gradient(90deg,#fff,#f7fff7); padding:14px;border-radius:12px; border:1px solid rgba(0,0,0,0.04)}
  #surpriseArea.show{display:block; opacity:1; transform:translateY(0)}
  #surpriseArea h3{margin:0 0 8px 0}
  #surpriseArea p{margin:0 color:#3b5b50; line-height:1.5}

  /* smoke */
  .smoke{position:fixed; border-radius:50%; pointer-events:none; mix-blend-mode:screen}

  canvas.confetti{position:fixed; left:0; top:0; width:100vw; height:100vh; pointer-events:none; z-index:9999}
</style>
</head>
<body>
  <canvas id="confettiCanvas" class="confetti" aria-hidden="true"></canvas>

  <main class="stage" role="main" aria-labelledby="pageTitle">
    <section class="left">
      <h1 id="pageTitle">Happy Birthday, <span id="namePlace">Maneesha</span> üéâ</h1>
      <div class="sub">A little surprise from your best friend ‚Äî blow the candle and make a wish!</div>

      <div class="card-text" id="shortCard">Wishing you a day of laughter, tiny adventures, and warm tea on cozy afternoons.</div>

      <div class="controls">
        <button id="playBtn">‚ñ∂Ô∏è Play/Stop Music</button>
        <button id="downloadBtn">üì∑ Save Portrait</button>
      </div>

      <div id="surpriseArea" role="status" aria-live="polite">
        <h3>Happy Birthday, my dear friend.</h3>
        <p id="finalMsg">You and I have always been like bread and jam ‚Äî inseparable in spirit, steady, and full of quiet sweetness. Thank you for being the heart that understands mine without words. I‚Äôm endlessly grateful for your presence in my life. Wishing you a year as gentle, beautiful, and warm as you are. üíõ‚ú®</p>
      </div>

      <div class="note">Tip: press <strong>B</strong> to blow the candle. Refresh page to replay the blow once.</div>
    </section>

    <aside class="side">
      <figure class="portrait" role="img" aria-label="Photo of Maneesha">
        <img id="portraitImg" alt="Maneesha portrait" crossorigin="anonymous" />
        <div class="placeholder" id="portraitPlaceholder" style="display:none">Maneesha</div>

        <div class="cake-wrap" id="cakeWrap">
          <div class="cake-card" id="cakeCard" role="button" aria-pressed="false" aria-label="Cake with candle. Click to blow.">
            <!-- cake SVG -->
            <svg class="cake-svg" viewBox="0 0 64 64" width="120" height="120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <rect x="8" y="28" width="48" height="18" rx="3" fill="#FFF9EE" stroke="#F3E7D6"/>
              <path d="M8 28c6-6 18-6 26-1 8-5 20-5 26 1" fill="#FFEEE9"/>
              <rect x="26" y="20" width="4" height="10" rx="0.6" fill="#FFFFFF" stroke="#FFEFCB"/>
              <g id="flameGroup">
                <path id="flame" class="flame" d="M32 16c0 2.6-2 3.8-2 3.8s0-2 0-3.8 1-2.4 2-2.4 1 0.6 1 2.4z" fill="#FFD66B"/>
                <path id="flameInner" class="flame" d="M32 17c0 1.6-1 2.2-1 2.2s0-1 0-2.2 0.6-1.2 1-1.2 1 0.2 1 1.2z" fill="#FFB86B" opacity="0.95"/>
              </g>
            </svg>

            <!-- larger invisible hit area (better for mobile) -->
            <button class="flame-hit" id="flameHit" aria-label="Blow the candle" title="Click to blow the candle"></button>
          </div>
          <div class="prompt" id="cakePrompt">Click the candle to blow it üí®</div>
        </div>
      </figure>
    </aside>
  </main>

<script>
/* ---------------- Config: change only these if needed ---------------- */
const recipientName = 'Maneesha';
const portraitDataURI = ""; // optional: paste full data:image/... base64 if you want single-file
const portraitLocalPath = "./image.jpg"; // the filename you uploaded at repo root
/* ------------------------------------------------------------------- */

document.getElementById('namePlace').textContent = recipientName;

/* ---------------- Portrait loading with fallback ---------------- */
const portraitImg = document.getElementById('portraitImg');
const portraitPlaceholder = document.getElementById('portraitPlaceholder');

function setPortrait(src){
  portraitPlaceholder.style.display = 'none';
  portraitImg.style.display = 'block';
  portraitImg.src = src;
  portraitImg.onerror = () => {
    console.warn("Portrait failed to load:", src);
    portraitImg.style.display = 'none';
    portraitPlaceholder.style.display = 'flex';
  };
}

if(portraitDataURI && portraitDataURI.startsWith('data:')){
  setPortrait(portraitDataURI);
} else {
  setPortrait(portraitLocalPath);
}

/* ---------------- Confetti ---------------- */
const confCanvas = document.getElementById('confettiCanvas');
const ctx = confCanvas.getContext('2d');
let dpr = window.devicePixelRatio || 1;
function resizeCanvas(){
  dpr = window.devicePixelRatio || 1;
  confCanvas.width = innerWidth * dpr;
  confCanvas.height = innerHeight * dpr;
  confCanvas.style.width = innerWidth + 'px';
  confCanvas.style.height = innerHeight + 'px';
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
resizeCanvas(); window.addEventListener('resize', resizeCanvas);

let confetti = [];
function spawnConfetti(n=140){
  for(let i=0;i<n;i++){
    confetti.push({
      x: Math.random()*innerWidth,
      y: -Math.random()*200,
      w: 6 + Math.random()*14,
      h: 4 + Math.random()*8,
      vx: -2 + Math.random()*4,
      vy: 2 + Math.random()*6,
      ang: Math.random()*Math.PI*2,
      vr: (-0.06 + Math.random()*0.12),
      color: ['#2FBF91','#FFD66B','#FFB86B','#72E0FF','#C2F7FF'][Math.floor(Math.random()*5)]
    });
  }
}
let confRunning = false;
function updateDrawConfetti(){
  ctx.clearRect(0,0,confCanvas.width,confCanvas.height);
  for(let p of confetti){
    p.x += p.vx; p.y += p.vy; p.ang += p.vr;
    ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.ang);
    ctx.fillStyle = p.color;
    ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
    ctx.restore();
  }
  confetti = confetti.filter(p => p.y < innerHeight + 120);
}
function confettiLoop(){
  if(!confRunning) return;
  updateDrawConfetti();
  requestAnimationFrame(confettiLoop);
}
function startConfetti(){
  if(confRunning) return;
  confRunning = true;
  spawnConfetti(180);
  confettiLoop();
  setTimeout(()=>{ confRunning=false; confetti=[]; ctx.clearRect(0,0,confCanvas.width,confCanvas.height); }, 7000);
}

/* ---------------- Smoke ---------------- */
const cakeCard = document.getElementById('cakeCard');
function makeSmokeBurst(count=7){
  for(let i=0;i<count;i++){
    setTimeout(()=>{
      const s = document.createElement('div');
      s.className = 'smoke';
      const size = 12 + Math.random()*36;
      s.style.width = s.style.height = size + 'px';
      const rect = cakeCard.getBoundingClientRect();
      const left = rect.left + rect.width/2 + (Math.random()*80-40) - size/2;
      const top = rect.top + rect.height*0.15 - size/2;
      s.style.left = left + 'px'; s.style.top = top + 'px';
      s.style.opacity = 0.95;
      s.style.background = 'radial-gradient(circle, rgba(200,200,200,0.95), rgba(160,160,160,0.2))';
      document.body.appendChild(s);
      const driftX = (-50 + Math.random()*100);
      const rise = -130 - Math.random()*80;
      s.animate([
        { transform:'translate(0,0) scale(0.6)', opacity:0.95 },
        { transform:`translate(${driftX}px, ${rise/2}px) scale(1.05)`, opacity:0.6 },
        { transform:`translate(${driftX*1.2}px, ${rise}px) scale(1.4)`, opacity:0.06 }
      ], { duration:1000 + Math.random()*600, easing:'ease-out' }).onfinish = ()=> s.remove();
    }, i*90);
  }
}

/* ---------------- WebAudio: louder richer "Happy Birthday" ---------------- */
let audioCtx = null;
let mainGain = null;
let musicLooping = false;

// create audio context on first user gesture
function createAudioIfNeeded(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    mainGain = audioCtx.createGain();
    mainGain.gain.value = 0.18; // master volume (feel free to reduce)
    mainGain.connect(audioCtx.destination);
  }
}

// helper to play a note (osc with envelope)
function playNote(freq, start, dur, type='sine', gain=0.6){
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type;
  o.frequency.setValueAtTime(freq, start);
  g.gain.setValueAtTime(0.00001, start);
  g.gain.linearRampToValueAtTime(gain*0.8, start + 0.02);
  g.gain.exponentialRampToValueAtTime(0.00001, start + dur*0.9 + 0.02);
  o.connect(g);
  // small filter for warmth
  const f = audioCtx.createBiquadFilter();
  f.type = 'lowpass'; f.frequency.value = Math.max(1200, freq*4);
  g.connect(f); f.connect(mainGain);
  o.start(start); o.stop(start + dur + 0.06);
}

// play the melody (happy birthday) with a warm pad underneath
function playHappyBirthday(atTime = null){
  createAudioIfNeeded();
  const now = atTime || audioCtx.currentTime + 0.02;

  // pad: long triangle with slow attack
  const padOsc = audioCtx.createOscillator();
  const padGain = audioCtx.createGain();
  padOsc.type = 'sawtooth';
  padOsc.frequency.value = 110; // A2-ish
  padGain.gain.value = 0.06;
  const padFilter = audioCtx.createBiquadFilter(); padFilter.type='lowpass'; padFilter.frequency.value=900;
  padOsc.connect(padFilter); padFilter.connect(mainGain);
  padOsc.start(now); padOsc.stop(now + 6.5);

  // melody frequencies approximate (in Hz) - "Happy Birthday" phrase
  // sequence derived to sound recognizably like "Happy Birthday"
  const notes = [
    {f:392,d:0.34}, // G4
    {f:392,d:0.34}, // G4
    {f:440,d:0.7},  // A4
    {f:392,d:0.7},  // G4
    {f:523.25,d:0.7},// C5
    {f:494,d:1.0},  // B4

    {f:392,d:0.34},
    {f:392,d:0.34},
    {f:440,d:0.7},
    {f:392,d:0.7},
    {f:587.33,d:0.7}, // D5
    {f:523.25,d:1.0},

    {f:392,d:0.34},
    {f:392,d:0.34},
    {f:784,d:0.7},   // G5
    {f:523.25,d:0.7},
    {f:494,d:0.7},
    {f:440,d:1.0},

    {f:659.25,d:0.34},
    {f:659.25,d:0.34},
    {f:523.25,d:0.7},
    {f:392,d:0.7},
    {f:587.33,d:0.7},
    {f:523.25,d:1.2}
  ];

  // play notes with a bright lead (square+triangle mix)
  let t = now + 0.08;
  for(const n of notes){
    // primary
    playNote(n.f, t, n.d, 'triangle', 0.8);
    // slight octave fattening
    playNote(n.f*2, t, n.d*0.9, 'square', 0.08);
    t += n.d * 0.98;
  }

  // return end time
  return t;
}

// looped playback used by Play button
let loopTimeout = null;
function startMusicLoop(){
  if(musicLooping) return;
  musicLooping = true;
  createAudioIfNeeded();
  function loopOnce(){
    if(!musicLooping) return;
    const endTime = playHappyBirthday();
    const remaining = Math.max(600, (endTime - audioCtx.currentTime)*1000);
    loopTimeout = setTimeout(()=> loopOnce(), remaining + 150);
  }
  loopOnce();
}
function stopMusicLoop(){
  musicLooping = false;
  if(loopTimeout) clearTimeout(loopTimeout);
}

/* ---------------- Blow sequence & UI reveal ---------------- */
const flame = document.getElementById('flame');
const flameInner = document.getElementById('flameInner');
const flameHit = document.getElementById('flameHit');
const cakePrompt = document.getElementById('cakePrompt');
const surpriseArea = document.getElementById('surpriseArea');

let hasBlown = false;
let blowing = false;

function extinguishFlame(){
  if(flame) flame.classList.add('extinguished');
  if(flameInner) flameInner.classList.add('extinguished');
}
function showWishMessage(){
  surpriseArea.classList.add('show');
  // small focus for accessibility
  surpriseArea.setAttribute('tabindex','-1'); surpriseArea.focus({preventScroll:true});
}

async function blowSequence(){
  if(hasBlown || blowing) return;
  blowing = true;
  cakeCard.setAttribute('aria-pressed','true');
  cakePrompt.textContent = 'Blowing ‚Äî make a wish!';
  // stronger puff sound
  try{
    createAudioIfNeeded();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type='sine'; o.frequency.value=1200; g.gain.value=0.002;
    o.connect(g); g.connect(mainGain);
    g.gain.exponentialRampToValueAtTime(0.08, audioCtx.currentTime + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.26);
    o.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.26);
    o.start(); o.stop(audioCtx.currentTime + 0.28);
  }catch(e){ console.warn('Audio not available:', e); }

  // visual extinguish & jiggle
  extinguishFlame();
  cakeCard.animate([
    { transform:'translateY(0)' },
    { transform:'translateY(-10px) rotate(-6deg)' },
    { transform:'translateY(0) rotate(3deg)' }
  ], { duration:460, iterations:3, easing:'ease-in-out' });

  // smoke
  makeSmokeBurst(9);

  // after small dramatic delay reveal confetti + music + wish
  setTimeout(()=>{
    startConfetti();
    // play full Happy Birthday melody (louder)
    try{ createAudioIfNeeded(); playHappyBirthday(); }catch(e){ console.warn(e); }
    // reveal wish
    showWishMessage();
    cakePrompt.textContent = 'Wish made! ‚ú® (Refresh to replay)';
    hasBlown = true; blowing = false;
  }, 1200);
}

/* ---------------- Event wiring ---------------- */
// flame hit large button
flameHit.addEventListener('click', (e)=>{ e.stopPropagation(); blowSequence(); });
cakeCard.addEventListener('click', ()=> blowSequence());
// keyboard B
window.addEventListener('keydown', (e)=>{ if(e.key && e.key.toLowerCase()==='b') blowSequence(); });

// Play/Stop music button
const playBtn = document.getElementById('playBtn');
playBtn.addEventListener('click', ()=>{
  createAudioIfNeeded();
  if(!musicLooping){
    startMusicLoop();
    playBtn.textContent = '‚è∏ Stop Music';
  } else {
    stopMusicLoop();
    playBtn.textContent = '‚ñ∂Ô∏è Play/Stop Music';
  }
});

/* ---------------- Portrait download ---------------- */
const downloadBtn = document.getElementById('downloadBtn');
downloadBtn.addEventListener('click', async ()=>{
  try{
    const src = portraitImg.src;
    const resp = await fetch(src, {mode:'cors'});
    const blob = await resp.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${recipientName||'portrait'}.jpg`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(a.href);
  }catch(err){
    console.warn("Download failed:", err);
    alert("Couldn't auto-download. Right-click the image and save, or upload the image to the repo root as image.jpg and try again.");
  }
});

/* console info */
console.log("Birthday page loaded. portraitDataURI length:", portraitDataURI.length, "Using local path:", portraitLocalPath);
</script>
</body>
</html>
